<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sovereign Mobile</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root { --neon: #00ff88; --mcp: #00ccff; --bg: #050505; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { margin: 0; background: var(--bg); color: var(--neon); font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* THE PICTURE (Top 40%) */
        #visual-field { height: 40vh; width: 100%; border-bottom: 2px solid #222; background: #000; }
        
        /* CONTROLS (Bottom 60%) */
        #interface { flex: 1; display: flex; flex-direction: column; padding: 15px; background: #0a0a0a; overflow-y: auto; }
        
        .nav { display: flex; gap: 10px; margin-bottom: 10px; }
        button { flex: 1; background: #111; border: 1px solid var(--neon); color: var(--neon); padding: 12px; font-weight: bold; border-radius: 8px; opacity: 0.5; pointer-events: none; }
        button.active { opacity: 1; pointer-events: auto; }
        button:active { background: var(--neon); color: #000; }

        #terminal { flex: 1; background: #000; border: 1px solid #222; padding: 10px; font-family: monospace; font-size: 11px; overflow-y: auto; margin-bottom: 10px; color: #fff; border-radius: 5px; min-height: 100px; }
        
        .upload-zone { border: 2px dashed var(--mcp); padding: 20px; text-align: center; color: var(--mcp); font-size: 12px; margin-bottom: 10px; border-radius: 8px; }
        input[type="text"] { background: #000; border: 1px solid var(--neon); color: #fff; padding: 15px; border-radius: 8px; font-size: 16px; width: 100%; }
    </style>
</head>
<body>

<div id="visual-field"><svg id="canvas" width="100%" height="100%"></svg></div>

<div id="interface">
    <div class="nav">
        <button id="back-btn" onclick="System.goBack()">‚è™ BACK</button>
        <button id="evolve-btn" onclick="System.evolve()">üíæ EVOLVE</button>
    </div>

    <div class="upload-zone" onclick="document.getElementById('file-in').click()">
        üìÇ TAP TO UPLOAD BRAIN / BOOK / ZIP
        <input type="file" id="file-in" hidden multiple onchange="System.handleFiles(this.files)">
    </div>

    <div id="terminal">Initializing Dual-Brain...</div>
    
    <input type="text" id="mcp-input" placeholder="Awaiting Handshake..." onkeypress="if(event.key==='Enter') System.chat()">
</div>

<script>
let pyodide, nodes = [{id: "CORE", color: "#00ccff", size: 15}], links = [];

const System = {
    async boot() {
        try {
            pyodide = await loadPyodide();
            this.log("‚úÖ Brain Active. Handshake confirmed.");
            // ACTIVATE BUTTONS
            document.querySelectorAll('button').forEach(b => b.classList.add('active'));
            document.getElementById('mcp-input').placeholder = "Chat with the field...";
            this.initGraph();
        } catch (e) { this.log("‚ùå Error: Check connection."); }
    },

    handleFiles(files) {
        for (let f of files) {
            this.log(`Ingesting: ${f.name}`);
            nodes.push({id: f.name, color: "#00ff88", size: 10});
            links.push({source: "CORE", target: f.name});
            this.render();
        }
    },

    async chat() {
        const input = document.getElementById('mcp-input');
        if(!input.value) return;
        this.log(`üë§: ${input.value}`);
        // Visual thought node
        const tid = "T-"+Date.now();
        nodes.push({id: tid, color: "#fff", size: 6});
        links.push({source: "CORE", target: tid});
        this.render();
        input.value = "";
    },

    log(m) {
        const t = document.getElementById('terminal');
        t.innerHTML += `<div>> ${m}</div>`;
        t.scrollTop = t.scrollHeight;
    },

    initGraph() { this.svg = d3.select("#canvas"); this.render(); },

    render() {
        const w = window.innerWidth, h = window.innerHeight * 0.4;
        this.svg.selectAll("*").remove();
        const sim = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(60))
            .force("charge", d3.forceManyBody().strength(-150))
            .force("center", d3.forceCenter(w / 2, h / 2));

        const link = this.svg.append("g").selectAll("line").data(links).enter().append("line").attr("stroke", "#333");
        const node = this.svg.append("g").selectAll("circle").data(nodes).enter().append("circle")
            .attr("r", d => d.size).attr("fill", d => d.color)
            .call(d3.drag().on("start", (e, d) => { if (!e.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
            .on("drag", (e, d) => { d.fx = e.x; d.fy = e.y; })
            .on("end", (e, d) => { if (!e.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }));

        sim.on("tick", () => {
            link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            node.attr("cx", d => d.x).attr("cy", d => d.y);
        });
    }
};
window.onload = () => System.boot();
</script>
</body>
</html>
